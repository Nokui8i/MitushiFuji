{%- liquid
  assign section_id = 'instagram-feed-' | append: section.id
  assign feed_url = section.settings.feed_url | default: 'https://mitushi-ig-proxy.vercel.app/api/feed'
  assign heading = section.settings.heading | default: 'Follow Us @mitushi'
  assign layout_mode = section.settings.layout_mode | default: 'grid'
  assign columns_desktop = section.settings.columns_desktop | default: 4
  assign columns_mobile = section.settings.columns_mobile | default: 2
  assign gap_size = section.settings.gap_size | default: 16
  assign border_radius = section.settings.border_radius | default: 12
  assign post_limit = section.settings.post_limit | default: 12
  assign show_follow_button = section.settings.show_follow_button
  assign follow_button_text = section.settings.follow_button_text | default: 'Follow @mitushi'
  assign instagram_handle = section.settings.instagram_handle | default: 'mitushi'
  assign heading_font_size = section.settings.heading_font_size | default: 100
  assign button_font_size = section.settings.button_font_size | default: 100
  assign media_ratio = section.settings.media_ratio | default: '1/1'
  
  assign ratio_value = '1'
  case media_ratio
    when '1/1'
      assign ratio_value = '1'
    when '2/3'
      assign ratio_value = '0.667'
    when '3/2'
      assign ratio_value = '1.5'
    when 'auto'
      assign ratio_value = 'auto'
  endcase
-%}

<div 
  class="section color-{{ section.settings.color_scheme }} {% if section.settings.remove_padding_top %}section-top-zero{% endif %} {% if section.settings.remove_padding_bottom %}section-bottom-zero{% endif %}" 
  id="{{ section_id }}"
>
  <div class="ctnr">
    {% if heading != blank %}
      <div class="instagram-feed__heading" style="--heading-font-size: {{ heading_font_size }}%; text-align: {{ section.settings.heading_alignment }};">
        <h2>{{ heading }}</h2>
        {% if section.settings.description != blank %}
          <p>{{ section.settings.description }}</p>
        {% endif %}
      </div>
    {% endif %}

    {% if show_follow_button %}
      <div class="instagram-feed__follow" style="text-align: {{ section.settings.heading_alignment }}; margin-bottom: 2rem; --button-font-size: {{ button_font_size }}%;">
                    <a 
                      href="https://www.instagram.com/{{ instagram_handle }}/" 
                      target="_blank" 
                      rel="noopener noreferrer"
                      class="instagram-feed__follow-btn"
                    >
                      {{ follow_button_text }}
                    </a>
      </div>
    {% endif %}

    <div 
      class="instagram-feed__container instagram-feed__container--{{ layout_mode }}"
      data-feed-url="{{ feed_url }}"
      data-post-limit="{{ post_limit }}"
      style="
        --gap: {{ gap_size }}px;
        --radius: {{ border_radius }}px;
        --columns-desktop: {{ columns_desktop }};
        --columns-mobile: {{ columns_mobile }};
        --ratio: {{ ratio_value }};
      "
    >
      <div class="instagram-feed__skeleton">
        {% for i in (1..post_limit) %}
          <div class="instagram-feed__skeleton-item"></div>
        {% endfor %}
      </div>

      <div class="instagram-feed__error" style="display: none;">
        <p>{{ section.settings.error_message | default: 'Unable to load Instagram feed. Please try again later.' }}</p>
      </div>

      <div class="instagram-feed__items" style="display: none;"></div>

      {% if layout_mode == 'slider' %}
        <button class="instagram-feed__nav-btn instagram-feed__nav-btn--prev" aria-label="Previous" style="display: none;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
        <button class="instagram-feed__nav-btn instagram-feed__nav-btn--next" aria-label="Next" style="display: none;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      {% endif %}
    </div>
  </div>
</div>

<style>
  .instagram-feed__container {
    position: relative;
    min-height: 200px;
  }

  .instagram-feed__container--grid {
    overflow: hidden;
    padding: 4px;
  }

  .instagram-feed__container--slider {
    overflow: hidden;
    position: relative;
  }

  .instagram-feed__heading h2 {
    font-size: calc(var(--heading-font-size, 100%) * 1em);
  }

  .instagram-feed__container--grid .instagram-feed__items {
    display: grid;
    grid-template-columns: repeat(var(--columns-mobile), 1fr);
    gap: var(--gap);
  }

  @media (min-width: 769px) {
    .instagram-feed__container--grid .instagram-feed__items {
      grid-template-columns: repeat(var(--columns-desktop), 1fr);
    }
  }

  .instagram-feed__container--slider .instagram-feed__items {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    gap: var(--gap);
    scrollbar-width: none;
  }

  .instagram-feed__container--slider .instagram-feed__items::-webkit-scrollbar {
    display: none;
  }

  .instagram-feed__item {
    position: relative;
    aspect-ratio: var(--ratio);
    border-radius: var(--radius);
    overflow: hidden;
    background: #f5f5f5;
    cursor: pointer;
    transition: transform 0.3s ease;
  }

  .instagram-feed__item:hover {
    transform: scale(1.02);
  }

  .instagram-feed__item-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .instagram-feed__skeleton {
    display: grid;
    grid-template-columns: repeat(var(--columns-mobile), 1fr);
    gap: var(--gap);
  }

  @media (min-width: 769px) {
    .instagram-feed__skeleton {
      grid-template-columns: repeat(var(--columns-desktop), 1fr);
    }
  }

  .instagram-feed__skeleton-item {
    aspect-ratio: var(--ratio);
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s ease-in-out infinite;
    border-radius: var(--radius);
  }

  @keyframes skeleton-loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  .instagram-feed__error {
    text-align: center;
    padding: 3rem 1rem;
    color: #666;
  }

  .instagram-feed__follow-btn {
    display: inline-block;
    padding: 12px 24px;
    background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: calc(var(--button-font-size, 100%) * 0.95rem);
    transition: transform 0.2s ease;
  }

  .instagram-feed__follow-btn:hover {
    transform: translateY(-2px);
  }

  .instagram-feed__container.loaded .instagram-feed__skeleton {
    display: none;
  }

  .instagram-feed__container.loaded .instagram-feed__items {
    display: grid !important;
  }

  .instagram-feed__container--slider.loaded .instagram-feed__items {
    display: flex !important;
  }

  .instagram-feed__nav-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.1);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #333;
    transition: all 0.3s ease;
    padding: 0;
  }

  .instagram-feed__nav-btn--prev {
    left: 12px;
  }

  .instagram-feed__nav-btn--next {
    right: 12px;
  }
</style>

<script>
(function() {
  'use strict';
  
  const sectionId = '{{ section_id }}';
  const container = document.querySelector(`#${sectionId} .instagram-feed__container`);
  
  if (!container) return;
  
  let feedUrl = container.dataset.feedUrl || 'https://mitushi-ig-proxy.vercel.app/api/feed';
  const postLimit = parseInt(container.dataset.postLimit) || 12;
  const itemsContainer = container.querySelector('.instagram-feed__items');
  const skeleton = container.querySelector('.instagram-feed__skeleton');
  const errorContainer = container.querySelector('.instagram-feed__error');
  
  if (!itemsContainer) return;
  
  let allFeedData = [];
  
  function createFeedItem(item, index) {
    const imageUrl = (item && item.image) ? String(item.image).trim() : '';
    if (!imageUrl || imageUrl.toLowerCase().endsWith('.mp4')) return null;
    
    const itemEl = document.createElement('div');
    itemEl.className = 'instagram-feed__item';
    itemEl.dataset.index = String(index);
    
    const link = document.createElement('div');
    link.className = 'instagram-feed__item-link';
    
    const img = document.createElement('img');
    img.src = imageUrl;
    img.alt = item.caption || 'Instagram post';
    img.className = 'instagram-feed__item-image';
    img.loading = 'lazy';
    
    img.onerror = function() {
      this.style.display = 'none';
      itemEl.style.background = '#f0f0f0';
    };
    
    link.appendChild(img);
    
    if (item.media_type === 'VIDEO' || item.product_type === 'REELS') {
      const playIcon = document.createElement('div');
      playIcon.className = 'instagram-feed__item-play-icon';
      playIcon.innerHTML = '<svg width="48" height="48" viewBox="0 0 48 48" fill="none"><circle cx="24" cy="24" r="24" fill="rgba(0,0,0,0.6)"/><path d="M18 16L32 24L18 32V16Z" fill="white"/></svg>';
      link.appendChild(playIcon);
    }
    
    if (item.permalink) {
      const linkEl = document.createElement('a');
      linkEl.href = item.permalink;
      linkEl.target = '_blank';
      linkEl.rel = 'noopener noreferrer';
      linkEl.style.textDecoration = 'none';
      linkEl.style.color = 'inherit';
      linkEl.style.display = 'block';
      linkEl.style.width = '100%';
      linkEl.style.height = '100%';
      linkEl.appendChild(link);
      itemEl.appendChild(linkEl);
    } else {
      itemEl.appendChild(link);
    }
    
    return itemEl;
  }
  
  async function loadFeed() {
    const url = `${feedUrl}${feedUrl.includes('?') ? '&' : '?'}limit=${postLimit}`;
    
    try {
      let response;
      try {
        response = await fetch(url, {
          method: 'GET',
          headers: { 'Accept': 'application/json' },
          mode: 'cors',
          credentials: 'omit'
        });
      } catch (fetchError) {
        console.error('Instagram Feed: Fetch error:', fetchError);
        if (fetchError.message && fetchError.message.includes('CORS')) {
          console.error('Instagram Feed: CORS error detected. Check API CORS configuration.');
        }
        throw fetchError;
      }
      
      if (response.status === 404 && feedUrl.includes('/api/feed')) {
        const fallbackUrl = feedUrl.replace('/api/feed', '/api/ig-feed');
        console.warn('Instagram Feed: /api/feed returned 404, trying fallback /api/ig-feed');
        response = await fetch(`${fallbackUrl}${fallbackUrl.includes('?') ? '&' : '?'}limit=${postLimit}`, {
          method: 'GET',
          headers: { 'Accept': 'application/json' },
          mode: 'cors',
          credentials: 'omit'
        });
      }
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('Instagram Feed: API error:', response.status, errorText);
        throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
      }
      
      const data = await response.json();
      console.log('Instagram Feed: Received data:', data);
      
      if (!data.items || !Array.isArray(data.items) || data.items.length === 0) {
        console.warn('Instagram Feed: No items in response', data);
        throw new Error('No items in feed');
      }
      
      itemsContainer.innerHTML = '';
      allFeedData = [];
      
      let itemsAdded = 0;
      data.items.slice(0, postLimit).forEach((item, idx) => {
        allFeedData.push(item);
        const itemEl = createFeedItem(item, idx);
        if (itemEl) {
          itemsContainer.appendChild(itemEl);
          itemsAdded++;
        }
      });
      
      console.log(`Instagram Feed: Added ${itemsAdded} items to feed`);
      
      if (skeleton) skeleton.style.display = 'none';
      itemsContainer.style.display = '';
      container.classList.add('loaded');
      
      if (container.classList.contains('instagram-feed__container--slider')) {
        initSliderNavigation();
      }
      
    } catch (error) {
      console.error('Instagram Feed Error:', error);
      console.error('Instagram Feed Error Details:', {
        message: error.message,
        stack: error.stack,
        feedUrl: feedUrl,
        postLimit: postLimit
      });
      if (skeleton) skeleton.style.display = 'none';
      if (itemsContainer) itemsContainer.style.display = 'none';
      if (errorContainer) {
        errorContainer.style.display = 'block';
        const errorText = errorContainer.querySelector('p');
        if (errorText && error.message) {
          errorText.textContent = `Error: ${error.message}`;
        }
      }
    }
  }
  
  function initSliderNavigation() {
    const prevBtn = container.querySelector('.instagram-feed__nav-btn--prev');
    const nextBtn = container.querySelector('.instagram-feed__nav-btn--next');
    if (!prevBtn || !nextBtn) return;
    
    function updateButtons() {
      const scrollLeft = itemsContainer.scrollLeft;
      const scrollWidth = itemsContainer.scrollWidth;
      const clientWidth = itemsContainer.clientWidth;
      const maxScroll = scrollWidth - clientWidth;
      
      prevBtn.disabled = scrollLeft <= 0;
      nextBtn.disabled = scrollLeft >= maxScroll - 1;
      
      if (scrollWidth > clientWidth) {
        prevBtn.style.display = 'flex';
        nextBtn.style.display = 'flex';
      } else {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
      }
    }
    
    prevBtn.addEventListener('click', function() {
      const itemWidth = itemsContainer.querySelector('.instagram-feed__item')?.offsetWidth || 0;
      const gap = parseInt(getComputedStyle(itemsContainer).gap) || 0;
      itemsContainer.scrollBy({ left: -(itemWidth + gap), behavior: 'smooth' });
    });
    
    nextBtn.addEventListener('click', function() {
      const itemWidth = itemsContainer.querySelector('.instagram-feed__item')?.offsetWidth || 0;
      const gap = parseInt(getComputedStyle(itemsContainer).gap) || 0;
      itemsContainer.scrollBy({ left: itemWidth + gap, behavior: 'smooth' });
    });
    
    itemsContainer.addEventListener('scroll', updateButtons);
    window.addEventListener('resize', updateButtons);
    setTimeout(updateButtons, 100);
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadFeed);
  } else {
    loadFeed();
  }
  
  if (window.Shopify && window.Shopify.designMode) {
    document.addEventListener('shopify:section:load', function(event) {
      if (event.detail && event.detail.sectionId === '{{ section.id }}') {
        setTimeout(loadFeed, 100);
      }
    });
  }
})();
</script>

{% schema %}
{
  "name": "Instagram Feed",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Follow Us @mitushi"
    },
    {
      "type": "range",
      "id": "heading_font_size",
      "label": "Heading Font Size",
      "min": 50,
      "max": 200,
      "step": 5,
      "unit": "%",
      "default": 100
    },
    {
      "type": "select",
      "id": "heading_alignment",
      "label": "Heading Alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description"
    },
    {
      "type": "text",
      "id": "feed_url",
      "label": "Feed API URL",
      "default": "https://mitushi-ig-proxy.vercel.app/api/feed"
    },
    {
      "type": "select",
      "id": "layout_mode",
      "label": "Layout Mode",
      "options": [
        { "value": "grid", "label": "Grid" },
        { "value": "slider", "label": "Slider" }
      ],
      "default": "grid"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "label": "Columns (Desktop)",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4
    },
    {
      "type": "range",
      "id": "columns_mobile",
      "label": "Columns (Mobile)",
      "min": 1,
      "max": 3,
      "step": 1,
      "default": 2
    },
    {
      "type": "range",
      "id": "gap_size",
      "label": "Gap Size",
      "min": 4,
      "max": 32,
      "step": 2,
      "unit": "px",
      "default": 16
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Border Radius",
      "min": 0,
      "max": 24,
      "step": 2,
      "unit": "px",
      "default": 12
    },
    {
      "type": "select",
      "id": "media_ratio",
      "label": "Media Ratio",
      "default": "1/1",
      "options": [
        { "value": "1/1", "label": "Square" },
        { "value": "2/3", "label": "Portrait 2:3" },
        { "value": "3/2", "label": "Landscape 3:2" },
        { "value": "auto", "label": "Auto" }
      ]
    },
    {
      "type": "range",
      "id": "post_limit",
      "label": "Number of Posts",
      "min": 6,
      "max": 24,
      "step": 1,
      "default": 12
    },
    {
      "type": "checkbox",
      "id": "show_follow_button",
      "label": "Show Follow Button",
      "default": true
    },
    {
      "type": "text",
      "id": "follow_button_text",
      "label": "Follow Button Text",
      "default": "Follow @mitushi"
    },
    {
      "type": "range",
      "id": "button_font_size",
      "label": "Button Font Size",
      "min": 50,
      "max": 200,
      "step": 5,
      "unit": "%",
      "default": 100
    },
    {
      "type": "text",
      "id": "instagram_handle",
      "label": "Instagram Handle",
      "default": "mitushi"
    },
    {
      "type": "text",
      "id": "error_message",
      "label": "Error Message",
      "default": "Unable to load Instagram feed. Please try again later."
    },
    {
      "type": "select",
      "id": "color_scheme",
      "label": "Color Scheme",
      "options": [
        { "value": "default", "label": "Default" },
        { "value": "inverse", "label": "Inverse" },
        { "value": "accent-1", "label": "Accent 1" },
        { "value": "accent-2", "label": "Accent 2" }
      ],
      "default": "default"
    },
    {
      "type": "checkbox",
      "id": "remove_padding_top",
      "label": "Remove Top Padding",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "remove_padding_bottom",
      "label": "Remove Bottom Padding",
      "default": false
    }
  ],
  "presets": [
    {
      "name": "Instagram Feed"
    }
  ]
}
{% endschema %}
