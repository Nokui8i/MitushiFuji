{%- liquid
  assign section_id = 'mitushi-ig-feed-' | append: section.id
  assign feed_url = section.settings.feed_url | default: ''
  assign heading = section.settings.heading | default: 'Follow Us @mitushi'
  assign layout_mode = section.settings.layout_mode | default: 'grid'
  assign columns_desktop = section.settings.columns_desktop | default: 4
  assign columns_mobile = section.settings.columns_mobile | default: 2
  assign gap_size = section.settings.gap_size | default: 16
  assign border_radius = section.settings.border_radius | default: 12
  assign post_limit = section.settings.post_limit | default: 12
  assign show_follow_button = section.settings.show_follow_button
  assign follow_button_text = section.settings.follow_button_text | default: 'Follow @mitushi'
  assign instagram_handle = section.settings.instagram_handle | default: 'mitushi'
-%}

<div 
  class="section color-{{ section.settings.color_scheme }} {{ section.settings.remove_padding_top | replace: 'true', 'section-top-zero' | replace: section.settings.remove_padding_top, '' }} {{ section.settings.remove_padding_bottom | replace: 'true', 'section-bottom-zero' | replace: section.settings.remove_padding_bottom, '' }} {% render 'animation-loader', section: section %}" 
  data-ui-component="MITUSHI Instagram Feed Section" 
  role="region" 
  aria-labelledby="sectionHeading-{{ section.id | md5 | truncate: 12, "" }}"
  id="{{ section_id }}"
>
  <div class="ctnr">
    {% if heading != blank %}
      {% render 'section-header', 
        content_align: section.settings.heading_alignment, 
        heading: heading, 
        description: section.settings.description, 
        section: section 
      %}
    {% endif %}

    {% if show_follow_button %}
      <div class="mitushi-ig-feed__follow-wrapper" style="text-align: {{ section.settings.heading_alignment }}; margin-bottom: 2rem;">
        <a 
          href="https://instagram.com/{{ instagram_handle }}" 
          target="_blank" 
          rel="noopener noreferrer"
          class="mitushi-ig-feed__follow-btn"
        >
          {{ follow_button_text }}
        </a>
      </div>
    {% endif %}

    <div 
      class="mitushi-ig-feed__container mitushi-ig-feed__container--{{ layout_mode }}"
      data-feed-url="{{ feed_url }}"
      data-post-limit="{{ post_limit }}"
      data-section-id="{{ section_id }}"
      style="
        --ig-gap: {{ gap_size }}px;
        --ig-border-radius: {{ border_radius }}px;
        --ig-columns-desktop: {{ columns_desktop }};
        --ig-columns-mobile: {{ columns_mobile }};
      "
    >
      <!-- Skeleton Loading State -->
      <div class="mitushi-ig-feed__skeleton" aria-hidden="true">
        {% for i in (1..post_limit) %}
          <div class="mitushi-ig-feed__skeleton-item"></div>
        {% endfor %}
      </div>

      <!-- Error State (hidden by default) -->
      <div class="mitushi-ig-feed__error" style="display: none;">
        <p>{{ section.settings.error_message | default: 'Unable to load Instagram feed. Please try again later.' }}</p>
      </div>

      <!-- Feed Items Container (populated by JS) -->
      <div class="mitushi-ig-feed__items" style="display: none;"></div>
    </div>
  </div>
</div>

<style>
  /* MITUSHI Instagram Feed Styles */
  .mitushi-ig-feed__container {
    position: relative;
    min-height: 200px;
  }

  /* Grid Layout */
  .mitushi-ig-feed__container--grid .mitushi-ig-feed__items {
    display: grid;
    grid-template-columns: repeat(var(--ig-columns-mobile), 1fr);
    gap: var(--ig-gap);
  }

  @media (min-width: 769px) {
    .mitushi-ig-feed__container--grid .mitushi-ig-feed__items {
      grid-template-columns: repeat(var(--ig-columns-desktop), 1fr);
    }
  }

  /* Slider Layout */
  .mitushi-ig-feed__container--slider .mitushi-ig-feed__items {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    gap: var(--ig-gap);
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
  }

  .mitushi-ig-feed__container--slider .mitushi-ig-feed__item {
    flex: 0 0 calc((100% - (var(--ig-columns-mobile) - 1) * var(--ig-gap)) / var(--ig-columns-mobile));
    scroll-snap-align: start;
  }

  @media (min-width: 769px) {
    .mitushi-ig-feed__container--slider .mitushi-ig-feed__item {
      flex: 0 0 calc((100% - (var(--ig-columns-desktop) - 1) * var(--ig-gap)) / var(--ig-columns-desktop));
    }
  }

  /* Feed Item */
  .mitushi-ig-feed__item {
    position: relative;
    aspect-ratio: 1 / 1;
    border-radius: var(--ig-border-radius);
    overflow: hidden;
    background: #f5f5f5;
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .mitushi-ig-feed__item:hover {
    transform: scale(1.02);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  }

  .mitushi-ig-feed__item-link {
    display: block;
    width: 100%;
    height: 100%;
    text-decoration: none;
    color: inherit;
  }

  .mitushi-ig-feed__item-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: opacity 0.3s ease;
  }

  .mitushi-ig-feed__item:hover .mitushi-ig-feed__item-image {
    opacity: 0.9;
  }

  /* Media Type Badge (optional indicator) */
  .mitushi-ig-feed__item-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(0, 0, 0, 0.6);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .mitushi-ig-feed__item:hover .mitushi-ig-feed__item-badge {
    opacity: 1;
  }

  /* Skeleton Loading */
  .mitushi-ig-feed__skeleton {
    display: grid;
    grid-template-columns: repeat(var(--ig-columns-mobile), 1fr);
    gap: var(--ig-gap);
  }

  @media (min-width: 769px) {
    .mitushi-ig-feed__skeleton {
      grid-template-columns: repeat(var(--ig-columns-desktop), 1fr);
    }
  }

  .mitushi-ig-feed__skeleton-item {
    aspect-ratio: 1 / 1;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s ease-in-out infinite;
    border-radius: var(--ig-border-radius);
  }

  @keyframes skeleton-loading {
    0% {
      background-position: 200% 0;
    }
    100% {
      background-position: -200% 0;
    }
  }

  /* Error State */
  .mitushi-ig-feed__error {
    text-align: center;
    padding: 3rem 1rem;
    color: #666;
  }

  .mitushi-ig-feed__error p {
    margin: 0;
    font-size: 0.95rem;
  }

  /* Follow Button */
  .mitushi-ig-feed__follow-btn {
    display: inline-block;
    padding: 12px 24px;
    background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.95rem;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    box-shadow: 0 2px 8px rgba(188, 24, 136, 0.3);
  }

  .mitushi-ig-feed__follow-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(188, 24, 136, 0.4);
  }

  .mitushi-ig-feed__follow-btn:active {
    transform: translateY(0);
  }

  /* Hide skeleton when feed loads */
  .mitushi-ig-feed__container.loaded .mitushi-ig-feed__skeleton {
    display: none;
  }

  .mitushi-ig-feed__container.loaded .mitushi-ig-feed__items {
    display: grid !important;
  }

  .mitushi-ig-feed__container--slider.loaded .mitushi-ig-feed__items {
    display: flex !important;
  }

  /* Slider scrollbar styling */
  .mitushi-ig-feed__container--slider .mitushi-ig-feed__items::-webkit-scrollbar {
    height: 6px;
  }

  .mitushi-ig-feed__container--slider .mitushi-ig-feed__items::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
  }

  .mitushi-ig-feed__container--slider .mitushi-ig-feed__items::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
  }

  .mitushi-ig-feed__container--slider .mitushi-ig-feed__items::-webkit-scrollbar-thumb:hover {
    background: #555;
  }
</style>

<script>
  (function() {
    'use strict';
    
    const sectionId = '{{ section_id }}';
    const container = document.querySelector(`#${sectionId} .mitushi-ig-feed__container`);
    
    if (!container) return;
    
    const feedUrl = container.dataset.feedUrl;
    const postLimit = parseInt(container.dataset.postLimit) || 12;
    const itemsContainer = container.querySelector('.mitushi-ig-feed__items');
    const skeleton = container.querySelector('.mitushi-ig-feed__skeleton');
    const errorContainer = container.querySelector('.mitushi-ig-feed__error');
    
    if (!feedUrl || feedUrl.trim() === '') {
      console.warn('MITUSHI IG Feed: No feed URL configured');
      if (skeleton) skeleton.style.display = 'none';
      if (errorContainer) {
        errorContainer.style.display = 'block';
        errorContainer.querySelector('p').textContent = 'Instagram feed URL not configured. Please set it in Theme Editor.';
      }
      return;
    }
    
    /**
     * Creates a feed item element
     * Returns null if item cannot be displayed (e.g., MP4 without thumbnail)
     */
    function createFeedItem(item) {
      // Validate item.image is a non-empty string
      const imageUrl = (item && item.image) ? String(item.image).trim() : '';
      
      // Skip items without image or if image is MP4 (video file, not thumbnail)
      if (!imageUrl || imageUrl.toLowerCase().endsWith('.mp4')) {
        return null;
      }
      
      const itemEl = document.createElement('div');
      itemEl.className = 'mitushi-ig-feed__item';
      
      const link = document.createElement('a');
      link.href = item.permalink || '#';
      link.target = '_blank';
      link.rel = 'noopener noreferrer';
      link.className = 'mitushi-ig-feed__item-link';
      link.setAttribute('aria-label', item.caption ? item.caption.substring(0, 100) : 'View Instagram post');
      
      const img = document.createElement('img');
      img.src = imageUrl;
      img.alt = item.caption || 'Instagram post';
      img.className = 'mitushi-ig-feed__item-image';
      img.loading = 'lazy';
      img.decoding = 'async';
      
      // Handle image load error
      img.onerror = function() {
        this.style.display = 'none';
        itemEl.style.background = '#f0f0f0';
      };
      
      link.appendChild(img);
      
      // Optional: Add media type badge for videos
      if (item.media_type === 'VIDEO') {
        const badge = document.createElement('span');
        badge.className = 'mitushi-ig-feed__item-badge';
        badge.textContent = 'Video';
        itemEl.appendChild(badge);
      }
      
      itemEl.appendChild(link);
      return itemEl;
    }
    
    /**
     * Fetches and renders the Instagram feed
     */
    async function loadFeed() {
      try {
        const url = `${feedUrl}${feedUrl.includes('?') ? '&' : '?'}limit=${postLimit}`;
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.items || !Array.isArray(data.items) || data.items.length === 0) {
          throw new Error('No items in feed response');
        }
        
        // Clear container
        itemsContainer.innerHTML = '';
        
        // Create and append items (only non-null items)
        data.items.slice(0, postLimit).forEach(item => {
          const itemEl = createFeedItem(item);
          if (itemEl) {
            itemsContainer.appendChild(itemEl);
          }
        });
        
        // Show items, hide skeleton
        if (skeleton) skeleton.style.display = 'none';
        itemsContainer.style.display = '';
        container.classList.add('loaded');
        
      } catch (error) {
        console.error('MITUSHI IG Feed Error:', error);
        
        // Show error state
        if (skeleton) skeleton.style.display = 'none';
        if (itemsContainer) itemsContainer.style.display = 'none';
        if (errorContainer) {
          errorContainer.style.display = 'block';
        }
      }
    }
    
    // Load feed when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadFeed);
    } else {
      loadFeed();
    }
  })();
</script>

{% schema %}
{
  "name": "MITUSHI Instagram Feed",
  "tag": "section",
  "class": "mitushi-instagram-feed-section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Follow Us @mitushi"
    },
    {
      "type": "select",
      "id": "heading_alignment",
      "label": "Heading Alignment",
      "options": [
        {
          "value": "ta-left",
          "label": "Left"
        },
        {
          "value": "ta-center",
          "label": "Center"
        },
        {
          "value": "ta-right",
          "label": "Right"
        }
      ],
      "default": "ta-center"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "info": "Optional description text below heading"
    },
    {
      "type": "url",
      "id": "feed_url",
      "label": "Feed API URL",
      "info": "Enter your Vercel API endpoint URL (e.g., https://your-project.vercel.app/api/ig-feed)"
    },
    {
      "type": "select",
      "id": "layout_mode",
      "label": "Layout Mode",
      "options": [
        {
          "value": "grid",
          "label": "Grid"
        },
        {
          "value": "slider",
          "label": "Slider"
        }
      ],
      "default": "grid"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "label": "Columns (Desktop)",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4
    },
    {
      "type": "range",
      "id": "columns_mobile",
      "label": "Columns (Mobile)",
      "min": 1,
      "max": 3,
      "step": 1,
      "default": 2
    },
    {
      "type": "range",
      "id": "gap_size",
      "label": "Gap Size",
      "min": 4,
      "max": 32,
      "step": 2,
      "unit": "px",
      "default": 16
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Border Radius",
      "min": 0,
      "max": 24,
      "step": 2,
      "unit": "px",
      "default": 12
    },
    {
      "type": "range",
      "id": "post_limit",
      "label": "Number of Posts",
      "min": 6,
      "max": 24,
      "step": 1,
      "default": 12
    },
    {
      "type": "checkbox",
      "id": "show_follow_button",
      "label": "Show Follow Button",
      "default": true
    },
    {
      "type": "text",
      "id": "follow_button_text",
      "label": "Follow Button Text",
      "default": "Follow @mitushi"
    },
    {
      "type": "text",
      "id": "instagram_handle",
      "label": "Instagram Handle",
      "info": "Without @ symbol (e.g., mitushi)",
      "default": "mitushi"
    },
    {
      "type": "text",
      "id": "error_message",
      "label": "Error Message",
      "default": "Unable to load Instagram feed. Please try again later.",
      "info": "Message shown if feed fails to load"
    },
    {
      "type": "select",
      "id": "color_scheme",
      "label": "Color Scheme",
      "options": [
        {
          "value": "default",
          "label": "Default"
        },
        {
          "value": "inverse",
          "label": "Inverse"
        },
        {
          "value": "accent-1",
          "label": "Accent 1"
        },
        {
          "value": "accent-2",
          "label": "Accent 2"
        }
      ],
      "default": "default"
    },
    {
      "type": "checkbox",
      "id": "remove_padding_top",
      "label": "Remove Top Padding",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "remove_padding_bottom",
      "label": "Remove Bottom Padding",
      "default": false
    }
  ],
  "presets": [
    {
      "name": "MITUSHI Instagram Feed"
    }
  ]
}
{% endschema %}
