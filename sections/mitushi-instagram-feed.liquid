{%- liquid
  assign section_id = 'mitushi-ig-feed-' | append: section.id
  assign feed_url = section.settings.feed_url | default: ''
  assign heading = section.settings.heading | default: 'Follow Us @mitushi'
  assign layout_mode = section.settings.layout_mode | default: 'grid'
  assign columns_desktop = section.settings.columns_desktop | default: 4
  assign columns_mobile = section.settings.columns_mobile | default: 2
  assign gap_size = section.settings.gap_size | default: 16
  assign border_radius = section.settings.border_radius | default: 12
  assign post_limit = section.settings.post_limit | default: 12
  assign show_follow_button = section.settings.show_follow_button
  assign follow_button_text = section.settings.follow_button_text | default: 'Follow @mitushi'
  assign instagram_handle = section.settings.instagram_handle | default: 'mitushi'
  assign heading_font_size = section.settings.heading_font_size | default: 100
  assign button_font_size = section.settings.button_font_size | default: 100
  assign media_ratio = section.settings.media_ratio | default: '1/1'
  
  # Calculate ratio value for CSS
  assign ratio_value = '1'
  case media_ratio
    when '1/1'
      assign ratio_value = '1'
    when '2/3'
      assign ratio_value = '0.667'
    when '3/2'
      assign ratio_value = '1.5'
    when 'auto'
      assign ratio_value = 'auto'
  endcase
-%}

<div 
  class="section color-{{ section.settings.color_scheme }} {{ section.settings.remove_padding_top | replace: 'true', 'section-top-zero' | replace: section.settings.remove_padding_top, '' }} {{ section.settings.remove_padding_bottom | replace: 'true', 'section-bottom-zero' | replace: section.settings.remove_padding_bottom, '' }} {% render 'animation-loader', section: section %}" 
  data-ui-component="MITUSHI Instagram Feed Section" 
  role="region" 
  aria-labelledby="sectionHeading-{{ section.id | md5 | truncate: 12, "" }}"
  id="{{ section_id }}"
>
  <div class="ctnr">
    {% if heading != blank %}
      <div class="mitushi-ig-feed__heading-wrapper" style="--heading-font-size: {{ heading_font_size }}%;">
        {% render 'section-header', 
          content_align: section.settings.heading_alignment, 
          heading: heading, 
          description: section.settings.description, 
          section: section 
        %}
      </div>
    {% endif %}

    {% if show_follow_button %}
      <div class="mitushi-ig-feed__follow-wrapper" style="text-align: {{ section.settings.heading_alignment }}; margin-bottom: 2rem; --button-font-size: {{ button_font_size }}%;">
        <a 
          href="https://instagram.com/{{ instagram_handle }}" 
          target="_blank" 
          rel="noopener noreferrer"
          class="mitushi-ig-feed__follow-btn"
        >
          {{ follow_button_text }}
        </a>
      </div>
    {% endif %}

    <div 
      class="mitushi-ig-feed__container mitushi-ig-feed__container--{{ layout_mode }}"
      data-feed-url="{{ feed_url }}"
      data-post-limit="{{ post_limit }}"
      data-section-id="{{ section_id }}"
      style="
        --ig-gap: {{ gap_size }}px;
        --ig-border-radius: {{ border_radius }}px;
        --ig-columns-desktop: {{ columns_desktop }};
        --ig-columns-mobile: {{ columns_mobile }};
        --ig-ratio: {{ ratio_value }};
        --ig-ratio-mode: {{ media_ratio }};
      "
    >
      <!-- Skeleton Loading State -->
      <div class="mitushi-ig-feed__skeleton" aria-hidden="true">
        {% for i in (1..post_limit) %}
          <div class="mitushi-ig-feed__skeleton-item"></div>
        {% endfor %}
      </div>

      <!-- Error State (hidden by default) -->
      <div class="mitushi-ig-feed__error" style="display: none;">
        <p>{{ section.settings.error_message | default: 'Unable to load Instagram feed. Please try again later.' }}</p>
      </div>

      <!-- Feed Items Container (populated by JS) -->
      <div class="mitushi-ig-feed__items" style="display: none;"></div>

      <!-- Navigation Buttons (Slider Only) -->
      {% if layout_mode == 'slider' %}
        <button class="mitushi-ig-feed__nav-btn mitushi-ig-feed__nav-btn--prev" aria-label="Previous" style="display: none;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button class="mitushi-ig-feed__nav-btn mitushi-ig-feed__nav-btn--next" aria-label="Next" style="display: none;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      {% endif %}

      <!-- Placeholder Items Container (Theme Editor Only - populated dynamically) -->
      {% if request.design_mode %}
        <div class="mitushi-ig-feed__placeholders" style="display: none;"></div>
      {% endif %}
    </div>
  </div>
</div>

<style>
  /* MITUSHI Instagram Feed Styles */
  .mitushi-ig-feed__container {
    position: relative;
    min-height: 200px;
  }

  /* Grid Layout - prevent scrollbar on hover */
  .mitushi-ig-feed__container--grid {
    overflow: hidden; /* Prevent scrollbar from hover scale */
    padding: 4px; /* Small padding to prevent hover scale from causing overflow */
  }

  /* Slider Layout - hide scrollbar, use navigation buttons */
  .mitushi-ig-feed__container--slider {
    overflow: hidden; /* Hide scrollbar completely */
    position: relative;
  }

  /* Heading Font Size Control */
  .mitushi-ig-feed__heading-wrapper h2,
  .mitushi-ig-feed__heading-wrapper .section-header__heading {
    font-size: calc(var(--heading-font-size, 100%) * 1em);
  }

  @media (max-width: 768px) {
    .mitushi-ig-feed__heading-wrapper h2,
    .mitushi-ig-feed__heading-wrapper .section-header__heading {
      font-size: calc(var(--heading-font-size, 100%) * 0.85em);
    }
  }

  /* Grid Layout */
  .mitushi-ig-feed__container--grid .mitushi-ig-feed__items {
    display: grid;
    grid-template-columns: repeat(var(--ig-columns-mobile), 1fr);
    gap: var(--ig-gap);
    overflow: visible; /* Allow hover scale to work without scrollbar */
  }

  @media (min-width: 769px) {
    .mitushi-ig-feed__container--grid .mitushi-ig-feed__items {
      grid-template-columns: repeat(var(--ig-columns-desktop), 1fr);
    }
  }

  /* Slider Layout */
  .mitushi-ig-feed__container--slider .mitushi-ig-feed__items {
    display: flex;
    overflow-x: auto;
    overflow-y: hidden; /* Prevent vertical scrollbar */
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    gap: var(--ig-gap);
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none; /* Hide scrollbar */
    -ms-overflow-style: none; /* Hide scrollbar in IE/Edge */
  }

  /* Hide scrollbar in WebKit browsers */
  .mitushi-ig-feed__container--slider .mitushi-ig-feed__items::-webkit-scrollbar {
    display: none;
  }

  .mitushi-ig-feed__container--slider .mitushi-ig-feed__item {
    flex: 0 0 calc((100% - (var(--ig-columns-mobile) - 1) * var(--ig-gap)) / var(--ig-columns-mobile));
    scroll-snap-align: start;
  }

  @media (min-width: 769px) {
    .mitushi-ig-feed__container--slider .mitushi-ig-feed__item {
      flex: 0 0 calc((100% - (var(--ig-columns-desktop) - 1) * var(--ig-gap)) / var(--ig-columns-desktop));
    }
  }

  /* Feed Item */
  .mitushi-ig-feed__item {
    position: relative;
    aspect-ratio: var(--ig-ratio);
    border-radius: var(--ig-border-radius);
    overflow: hidden;
    background: #f5f5f5;
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    will-change: transform;
  }

  /* Auto ratio - use image's natural aspect ratio */
  .mitushi-ig-feed__item[data-ratio-auto="true"] {
    aspect-ratio: var(--item-aspect-ratio, 1);
    height: auto;
  }

  .mitushi-ig-feed__item[data-ratio-auto="true"] .mitushi-ig-feed__item-image {
    width: 100%;
    height: 100%;
    object-fit: contain; /* Show full image without cropping */
  }

  .mitushi-ig-feed__item:hover {
    transform: scale(1.02);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    z-index: 1;
  }

  .mitushi-ig-feed__item-link {
    display: block;
    width: 100%;
    height: 100%;
    text-decoration: none;
    color: inherit;
  }

  .mitushi-ig-feed__item-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    display: block;
    transition: opacity 0.3s ease;
    /* Ensure image fits perfectly in square container */
    min-width: 100%;
    min-height: 100%;
  }

  .mitushi-ig-feed__item:hover .mitushi-ig-feed__item-image {
    opacity: 0.9;
  }

  /* Media Type Badge (optional indicator) */
  .mitushi-ig-feed__item-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(0, 0, 0, 0.6);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .mitushi-ig-feed__item:hover .mitushi-ig-feed__item-badge {
    opacity: 1;
  }

  /* Skeleton Loading */
  .mitushi-ig-feed__skeleton {
    display: grid;
    grid-template-columns: repeat(var(--ig-columns-mobile), 1fr);
    gap: var(--ig-gap);
  }

  @media (min-width: 769px) {
    .mitushi-ig-feed__skeleton {
      grid-template-columns: repeat(var(--ig-columns-desktop), 1fr);
    }
  }

  .mitushi-ig-feed__skeleton-item {
    aspect-ratio: var(--ig-ratio);
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s ease-in-out infinite;
    border-radius: var(--ig-border-radius);
  }

  @keyframes skeleton-loading {
    0% {
      background-position: 200% 0;
    }
    100% {
      background-position: -200% 0;
    }
  }

  /* Error State */
  .mitushi-ig-feed__error {
    text-align: center;
    padding: 3rem 1rem;
    color: #666;
  }

  .mitushi-ig-feed__error p {
    margin: 0;
    font-size: 0.95rem;
  }

  /* Follow Button */
  .mitushi-ig-feed__follow-btn {
    display: inline-block;
    padding: 12px 24px;
    background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: calc(var(--button-font-size, 100%) * 0.95rem);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    box-shadow: 0 2px 8px rgba(188, 24, 136, 0.3);
    white-space: nowrap;
  }

  @media (max-width: 768px) {
    .mitushi-ig-feed__follow-btn {
      font-size: calc(var(--button-font-size, 100%) * 0.85rem);
      padding: 10px 20px;
    }
  }

  .mitushi-ig-feed__follow-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(188, 24, 136, 0.4);
  }

  .mitushi-ig-feed__follow-btn:active {
    transform: translateY(0);
  }

  /* Hide skeleton when feed loads */
  .mitushi-ig-feed__container.loaded .mitushi-ig-feed__skeleton {
    display: none;
  }

  .mitushi-ig-feed__container.loaded .mitushi-ig-feed__items {
    display: grid !important;
  }

  .mitushi-ig-feed__container--slider.loaded .mitushi-ig-feed__items {
    display: flex !important;
  }

  /* Placeholder Items (Theme Editor Only - added directly to itemsContainer) */
  .mitushi-ig-feed__placeholder-item {
    aspect-ratio: var(--ig-ratio);
    background: #e5e5e5;
    border-radius: var(--ig-border-radius);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
    min-width: 0;
  }

  .mitushi-ig-feed__container--slider .mitushi-ig-feed__placeholder-item {
    flex: 0 0 calc((100% - (var(--ig-columns-mobile) - 1) * var(--ig-gap)) / var(--ig-columns-mobile));
    scroll-snap-align: start;
    min-width: 0;
  }

  @media (min-width: 769px) {
    .mitushi-ig-feed__container--slider .mitushi-ig-feed__placeholder-item {
      flex: 0 0 calc((100% - (var(--ig-columns-desktop) - 1) * var(--ig-gap)) / var(--ig-columns-desktop));
    }
  }

  .mitushi-ig-feed__placeholder-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    color: #999;
    font-size: 0.85rem;
    font-weight: 500;
  }

  .mitushi-ig-feed__placeholder-content svg {
    opacity: 0.5;
  }

  /* Items and placeholders appear together in Theme Editor (both in itemsContainer) */
  .mitushi-ig-feed__container.loaded .mitushi-ig-feed__items {
    display: grid !important;
  }

  .mitushi-ig-feed__container--slider.loaded .mitushi-ig-feed__items {
    display: flex !important;
  }

  /* Navigation Buttons (Slider Only) */
  .mitushi-ig-feed__nav-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.1);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #333;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    padding: 0;
  }

  .mitushi-ig-feed__nav-btn:hover {
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-50%) scale(1.05);
  }

  .mitushi-ig-feed__nav-btn:active {
    transform: translateY(-50%) scale(0.95);
  }

  .mitushi-ig-feed__nav-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    pointer-events: none;
  }

  .mitushi-ig-feed__nav-btn--prev {
    left: 12px;
  }

  .mitushi-ig-feed__nav-btn--next {
    right: 12px;
  }

  @media (max-width: 768px) {
    .mitushi-ig-feed__nav-btn {
      width: 40px;
      height: 40px;
    }

    .mitushi-ig-feed__nav-btn--prev {
      left: 8px;
    }

    .mitushi-ig-feed__nav-btn--next {
      right: 8px;
    }

    .mitushi-ig-feed__nav-btn svg {
      width: 20px;
      height: 20px;
    }
  }

  /* Lightbox Modal */
  .mitushi-ig-feed__lightbox {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .mitushi-ig-feed__lightbox.active {
    display: flex;
    opacity: 1;
  }

  .mitushi-ig-feed__lightbox-content {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .mitushi-ig-feed__lightbox-image,
  .mitushi-ig-feed__lightbox-video {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
    border-radius: 8px;
  }

  .mitushi-ig-feed__lightbox-close {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 10000;
  }

  .mitushi-ig-feed__lightbox-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
  }

  .mitushi-ig-feed__lightbox-close svg {
    width: 24px;
    height: 24px;
  }

  .mitushi-ig-feed__lightbox-link {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 12px 24px;
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
  }

  .mitushi-ig-feed__lightbox-link:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateX(-50%) translateY(-2px);
  }

  /* Play icon for videos/reels */
  .mitushi-ig-feed__item-play-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    z-index: 2;
    opacity: 0.9;
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  .mitushi-ig-feed__item:hover .mitushi-ig-feed__item-play-icon {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.1);
  }

  .mitushi-ig-feed__item-play-icon svg {
    width: 48px;
    height: 48px;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
  }

  @media (max-width: 768px) {
    .mitushi-ig-feed__item-play-icon svg {
      width: 40px;
      height: 40px;
    }
  }

  /* Lightbox navigation buttons */
  .mitushi-ig-feed__lightbox-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 10001;
    backdrop-filter: blur(10px);
  }

  .mitushi-ig-feed__lightbox-nav:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-50%) scale(1.1);
  }

  .mitushi-ig-feed__lightbox-nav:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    pointer-events: none;
  }

  .mitushi-ig-feed__lightbox-nav--prev {
    left: 20px;
  }

  .mitushi-ig-feed__lightbox-nav--next {
    right: 20px;
  }

  .mitushi-ig-feed__lightbox-nav svg {
    width: 24px;
    height: 24px;
  }

  @media (max-width: 768px) {
    .mitushi-ig-feed__lightbox-nav {
      width: 40px;
      height: 40px;
    }

    .mitushi-ig-feed__lightbox-nav--prev {
      left: 10px;
    }

    .mitushi-ig-feed__lightbox-nav--next {
      right: 10px;
    }

    .mitushi-ig-feed__lightbox-nav svg {
      width: 20px;
      height: 20px;
    }
  }
</style>

<script>
  (function() {
    'use strict';
    
    const sectionId = '{{ section_id }}';
    const container = document.querySelector(`#${sectionId} .mitushi-ig-feed__container`);
    
    if (!container) {
      console.warn('MITUSHI IG Feed: Container not found');
      return;
    }
    
    let feedUrl = container.dataset.feedUrl;
    // Use default URL if feed_url is empty
    if (!feedUrl || feedUrl.trim() === '') {
      feedUrl = 'https://mitushi-ig-proxy.vercel.app/api/feed';
    }
    const postLimit = parseInt(container.dataset.postLimit) || 12;
    const itemsContainer = container.querySelector('.mitushi-ig-feed__items');
    const skeleton = container.querySelector('.mitushi-ig-feed__skeleton');
    const errorContainer = container.querySelector('.mitushi-ig-feed__error');
    
    if (!itemsContainer) {
      console.error('MITUSHI IG Feed: Items container not found');
      return;
    }
    
    // Get ratio mode from container style
    const ratioMode = getComputedStyle(container).getPropertyValue('--ig-ratio-mode').trim();
    
    /**
     * Creates a feed item element
     * Returns null if item cannot be displayed (e.g., MP4 without thumbnail)
     */
    function createFeedItem(item, index) {
      // Validate item.image is a non-empty string
      const imageUrl = (item && item.image) ? String(item.image).trim() : '';
      
      // Skip items without image or if image is MP4 (video file, not thumbnail)
      if (!imageUrl || imageUrl.toLowerCase().endsWith('.mp4')) {
        return null;
      }
      
      const itemEl = document.createElement('div');
      itemEl.className = 'mitushi-ig-feed__item';
      itemEl.dataset.index = String(index);
      
      // Remove link - we'll handle click with lightbox
      const link = document.createElement('div');
      link.className = 'mitushi-ig-feed__item-link';
      link.setAttribute('aria-label', item.caption ? item.caption.substring(0, 100) : 'View Instagram post');
      
      const img = document.createElement('img');
      img.src = imageUrl;
      img.alt = item.caption || 'Instagram post';
      img.className = 'mitushi-ig-feed__item-image';
      img.loading = 'lazy';
      img.decoding = 'async';
      
      // Handle auto ratio - use image's natural aspect ratio
      if (ratioMode === 'auto') {
        itemEl.setAttribute('data-ratio-auto', 'true');
        img.onload = function() {
          if (this.naturalWidth && this.naturalHeight) {
            const aspectRatio = this.naturalWidth / this.naturalHeight;
            itemEl.style.setProperty('--item-aspect-ratio', aspectRatio);
          }
        };
      }
      
      // Handle image load error
      img.onerror = function() {
        this.style.display = 'none';
        itemEl.style.background = '#f0f0f0';
      };
      
      link.appendChild(img);
      
      // Add play icon for videos/reels
      if (item.media_type === 'VIDEO' || item.product_type === 'REELS') {
        const playIcon = document.createElement('div');
        playIcon.className = 'mitushi-ig-feed__item-play-icon';
        playIcon.innerHTML = `
          <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="24" cy="24" r="24" fill="rgba(0, 0, 0, 0.6)"/>
            <path d="M18 16L32 24L18 32V16Z" fill="white"/>
          </svg>
        `;
        link.appendChild(playIcon);
      }
      
      // Add click handler
      itemEl.addEventListener('click', function(e) {
        e.preventDefault();
        openLightbox(index);
      });
      
      itemEl.appendChild(link);
      return itemEl;
    }
    
    /**
     * Fetches and renders the Instagram feed
     */
    async function loadFeed() {
      // Define url outside try block so it's available in catch
      const url = `${feedUrl}${feedUrl.includes('?') ? '&' : '?'}limit=${postLimit}`;
      
      try {
        console.log('MITUSHI IG Feed: Loading feed from', feedUrl);
        console.log('MITUSHI IG Feed: Fetching URL', url);
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('MITUSHI IG Feed: Received data', data);
        
        if (!data.items || !Array.isArray(data.items) || data.items.length === 0) {
          console.warn('MITUSHI IG Feed: No items in response', data);
          throw new Error('No items in feed response');
        }
        
        // Clear container
        itemsContainer.innerHTML = '';
        
        // Create and append items (only non-null items)
        const validItems = [];
        allFeedData = []; // Reset for navigation - store DATA, not DOM elements!
        data.items.slice(0, postLimit).forEach((item, idx) => {
          // Store data first
          allFeedData.push(item);
          
          const itemEl = createFeedItem(item, idx);
          if (itemEl) {
            validItems.push(itemEl);
            itemsContainer.appendChild(itemEl);
          }
        });
        
        // In Theme Editor: add placeholder boxes for missing posts directly to itemsContainer
        const isThemeEditor = window.Shopify && window.Shopify.designMode;
        if (isThemeEditor && validItems.length < postLimit) {
          const missingCount = postLimit - validItems.length;
          
          for (let i = 0; i < missingCount; i++) {
            const placeholderEl = document.createElement('div');
            placeholderEl.className = 'mitushi-ig-feed__placeholder-item';
            placeholderEl.innerHTML = `
              <div class="mitushi-ig-feed__placeholder-content">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM12 6C9.79 6 8 7.79 8 10C8 12.21 9.79 14 12 14C14.21 14 16 12.21 16 10C16 7.79 14.21 6 12 6ZM12 12C10.9 12 10 11.1 10 10C10 8.9 10.9 8 12 8C13.1 8 14 8.9 14 10C14 11.1 13.1 12 12 12Z" fill="#999"/>
                </svg>
                <span>Preview</span>
              </div>
            `;
            itemsContainer.appendChild(placeholderEl);
          }
        }
        
        // Hide placeholders container (not used anymore)
        const placeholdersContainer = container.querySelector('.mitushi-ig-feed__placeholders');
        if (placeholdersContainer) placeholdersContainer.style.display = 'none';
        
        // Show items, hide skeleton
        if (skeleton) skeleton.style.display = 'none';
        itemsContainer.style.display = '';
        container.classList.add('loaded');
        
        // Initialize slider navigation and lightbox
        if (container.classList.contains('mitushi-ig-feed__container--slider')) {
          initSliderNavigation();
        }
        initLightbox();
        
        console.log('MITUSHI IG Feed: Loaded', validItems.length, 'posts');
        
      } catch (error) {
        console.error('MITUSHI IG Feed Error:', error);
        console.error('MITUSHI IG Feed Error Details:', {
          message: error.message,
          stack: error.stack,
          feedUrl: feedUrl,
          url: url
        });
        
        // Show error state
        if (skeleton) skeleton.style.display = 'none';
        if (itemsContainer) itemsContainer.style.display = 'none';
        
        // In Theme Editor: show placeholders on error (to show layout)
        const isThemeEditor = window.Shopify && window.Shopify.designMode;
        if (isThemeEditor && itemsContainer) {
          // Show all placeholders if error (to show full layout)
          itemsContainer.innerHTML = '';
          itemsContainer.style.display = '';
          for (let i = 0; i < postLimit; i++) {
            const placeholderEl = document.createElement('div');
            placeholderEl.className = 'mitushi-ig-feed__placeholder-item';
            placeholderEl.innerHTML = `
              <div class="mitushi-ig-feed__placeholder-content">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM12 6C9.79 6 8 7.79 8 10C8 12.21 9.79 14 12 14C14.21 14 16 12.21 16 10C16 7.79 14.21 6 12 6ZM12 12C10.9 12 10 11.1 10 10C10 8.9 10.9 8 12 8C13.1 8 14 8.9 14 10C14 11.1 13.1 12 12 12Z" fill="#999"/>
                </svg>
                <span>Preview</span>
              </div>
            `;
            itemsContainer.appendChild(placeholderEl);
          }
        }
        
        // Hide placeholders container (not used anymore)
        const placeholdersContainer = container.querySelector('.mitushi-ig-feed__placeholders');
        if (placeholdersContainer) placeholdersContainer.style.display = 'none';
        
        if (errorContainer) {
          errorContainer.style.display = 'block';
        }
      }
    }
    
    /**
     * Initialize slider navigation buttons
     */
    function initSliderNavigation() {
      const prevBtn = container.querySelector('.mitushi-ig-feed__nav-btn--prev');
      const nextBtn = container.querySelector('.mitushi-ig-feed__nav-btn--next');
      
      if (!prevBtn || !nextBtn || !itemsContainer) return;
      
      function updateButtons() {
        const scrollLeft = itemsContainer.scrollLeft;
        const scrollWidth = itemsContainer.scrollWidth;
        const clientWidth = itemsContainer.clientWidth;
        const maxScroll = scrollWidth - clientWidth;
        
        prevBtn.disabled = scrollLeft <= 0;
        nextBtn.disabled = scrollLeft >= maxScroll - 1; // -1 for rounding errors
        
        // Show buttons only if there's overflow
        if (scrollWidth > clientWidth) {
          prevBtn.style.display = 'flex';
          nextBtn.style.display = 'flex';
        } else {
          prevBtn.style.display = 'none';
          nextBtn.style.display = 'none';
        }
      }
      
      prevBtn.addEventListener('click', function() {
        const itemWidth = itemsContainer.querySelector('.mitushi-ig-feed__item')?.offsetWidth || 0;
        const gap = parseInt(getComputedStyle(itemsContainer).gap) || 0;
        itemsContainer.scrollBy({
          left: -(itemWidth + gap),
          behavior: 'smooth'
        });
      });
      
      nextBtn.addEventListener('click', function() {
        const itemWidth = itemsContainer.querySelector('.mitushi-ig-feed__item')?.offsetWidth || 0;
        const gap = parseInt(getComputedStyle(itemsContainer).gap) || 0;
        itemsContainer.scrollBy({
          left: itemWidth + gap,
          behavior: 'smooth'
        });
      });
      
      itemsContainer.addEventListener('scroll', updateButtons);
      window.addEventListener('resize', updateButtons);
      
      // Initial update
      setTimeout(updateButtons, 100);
    }
    
    // Store all feed data for navigation (not DOM elements!)
    let allFeedData = [];
    let currentLightboxIndex = -1;
    
    /**
     * Navigate lightbox to next/previous item
     */
    function navigateLightbox(direction) {
      if (allFeedData.length === 0) return;
      
      currentLightboxIndex = (currentLightboxIndex + direction + allFeedData.length) % allFeedData.length;
      renderLightbox();
      updateNavButtons();
    }
    
    /**
     * Update navigation buttons state
     */
    function updateNavButtons() {
      const lightbox = document.querySelector('.mitushi-ig-feed__lightbox');
      if (!lightbox) return;
      
      const prevBtn = lightbox.querySelector('.mitushi-ig-feed__lightbox-nav--prev');
      const nextBtn = lightbox.querySelector('.mitushi-ig-feed__lightbox-nav--next');
      
      if (allFeedData.length <= 1) {
        if (prevBtn) prevBtn.style.display = 'none';
        if (nextBtn) nextBtn.style.display = 'none';
      } else {
        if (prevBtn) prevBtn.style.display = 'flex';
        if (nextBtn) nextBtn.style.display = 'flex';
      }
    }
    
    /**
     * Render lightbox content based on current index
     */
    function renderLightbox() {
      if (currentLightboxIndex < 0 || currentLightboxIndex >= allFeedData.length) return;
      
      const item = allFeedData[currentLightboxIndex];
      const lightbox = document.querySelector('.mitushi-ig-feed__lightbox');
      if (!lightbox) return;
      
      const content = lightbox.querySelector('.mitushi-ig-feed__lightbox-content');
      const link = lightbox.querySelector('.mitushi-ig-feed__lightbox-link');
      if (!content) return;
      
      // Clear previous content
      const existingMedia = content.querySelector('.mitushi-ig-feed__lightbox-image, .mitushi-ig-feed__lightbox-video');
      if (existingMedia) existingMedia.remove();
      
      // Create media element based on type
      if (item.media_type === 'VIDEO' && item.video_url) {
        const video = document.createElement('video');
        video.className = 'mitushi-ig-feed__lightbox-video';
        video.src = item.video_url;
        video.controls = true;
        video.autoplay = true;
        video.playsInline = true;
        content.insertBefore(video, link);
      } else {
        const img = document.createElement('img');
        img.className = 'mitushi-ig-feed__lightbox-image';
        img.src = item.image;
        img.alt = item.caption || 'Instagram post';
        content.insertBefore(img, link);
      }
      
      // Update link
      if (item.permalink && item.permalink !== '#') {
        link.href = item.permalink;
        link.style.display = 'block';
      } else {
        link.style.display = 'none';
      }
    }
    
    /**
     * Initialize lightbox modal
     */
    function initLightbox() {
      // Create lightbox if it doesn't exist
      let lightbox = document.querySelector('.mitushi-ig-feed__lightbox');
      if (!lightbox) {
        lightbox = document.createElement('div');
        lightbox.className = 'mitushi-ig-feed__lightbox';
        lightbox.innerHTML = `
          <button class="mitushi-ig-feed__lightbox-nav mitushi-ig-feed__lightbox-nav--prev" aria-label="Previous">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <button class="mitushi-ig-feed__lightbox-nav mitushi-ig-feed__lightbox-nav--next" aria-label="Next">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div class="mitushi-ig-feed__lightbox-content">
            <button class="mitushi-ig-feed__lightbox-close" aria-label="Close">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <a class="mitushi-ig-feed__lightbox-link" href="#" target="_blank" rel="noopener noreferrer" style="display: none;">
              View on Instagram
            </a>
          </div>
        `;
        document.body.appendChild(lightbox);
        
        // Close on click outside or close button
        lightbox.addEventListener('click', function(e) {
          if (e.target === lightbox || e.target.closest('.mitushi-ig-feed__lightbox-close')) {
            closeLightbox();
          }
        });
        
        // Navigation buttons
        const prevBtn = lightbox.querySelector('.mitushi-ig-feed__lightbox-nav--prev');
        const nextBtn = lightbox.querySelector('.mitushi-ig-feed__lightbox-nav--next');
        
        prevBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          navigateLightbox(-1);
        });
        
        nextBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          navigateLightbox(1);
        });
        
        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
          if (!lightbox.classList.contains('active')) return;
          
          if (e.key === 'Escape') {
            closeLightbox();
          } else if (e.key === 'ArrowLeft') {
            navigateLightbox(-1);
          } else if (e.key === 'ArrowRight') {
            navigateLightbox(1);
          }
        });
      }
      
      // Click handlers are now attached in createFeedItem() - no need for delegation here
    }
    
    /**
     * Open lightbox with item index
     */
    function openLightbox(index) {
      if (index < 0 || index >= allFeedData.length) return;
      
      currentLightboxIndex = index;
      const lightbox = document.querySelector('.mitushi-ig-feed__lightbox');
      if (!lightbox) return;
      
      renderLightbox();
      updateNavButtons();
      
      // Show lightbox
      lightbox.classList.add('active');
      document.body.style.overflow = 'hidden'; // Prevent body scroll
    }
    
    /**
     * Close lightbox
     */
    function closeLightbox() {
      const lightbox = document.querySelector('.mitushi-ig-feed__lightbox');
      if (!lightbox) return;
      
      lightbox.classList.remove('active');
      document.body.style.overflow = ''; // Restore body scroll
      
      // Stop video if playing
      const video = lightbox.querySelector('.mitushi-ig-feed__lightbox-video');
      if (video) {
        video.pause();
        video.currentTime = 0;
      }
    }
    
    // Load feed in both Theme Editor and live site
    // In Theme Editor, placeholders will be added dynamically if needed
    // Always load feed, even in Theme Editor, to show real posts
    const isThemeEditor = window.Shopify && window.Shopify.designMode;
    
    console.log('MITUSHI IG Feed: Initializing v2.1.0', new Date().toISOString(), 'isThemeEditor:', isThemeEditor, 'feedUrl:', feedUrl);
    
    // Load feed immediately
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        console.log('MITUSHI IG Feed: DOM loaded, calling loadFeed');
        loadFeed();
      });
    } else {
      console.log('MITUSHI IG Feed: DOM ready, calling loadFeed');
      loadFeed();
    }
    
    // In Theme Editor, reload feed when settings change
    if (isThemeEditor) {
      // Listen for section reload events
      document.addEventListener('shopify:section:load', function(event) {
        console.log('MITUSHI IG Feed: Section load event', event.detail);
        if (event.detail && event.detail.sectionId === '{{ section.id }}') {
          setTimeout(function() {
            console.log('MITUSHI IG Feed: Reloading feed after section load');
            loadFeed();
          }, 100);
        }
      });
      
      // Also listen for section select events
      document.addEventListener('shopify:section:select', function(event) {
        if (event.detail && event.detail.sectionId === '{{ section.id }}') {
          setTimeout(function() {
            console.log('MITUSHI IG Feed: Reloading feed after section select');
            loadFeed();
          }, 100);
        }
      });
    }
  })();
</script>

{% schema %}
{
  "name": "MITUSHI Instagram Feed",
  "tag": "section",
  "class": "mitushi-instagram-feed-section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Follow Us @mitushi"
    },
    {
      "type": "range",
      "id": "heading_font_size",
      "label": "Heading Font Size",
      "min": 50,
      "max": 200,
      "step": 5,
      "unit": "%",
      "default": 100,
      "info": "Adjust heading text size (50% - 200%)"
    },
    {
      "type": "select",
      "id": "heading_alignment",
      "label": "Heading Alignment",
      "options": [
        {
          "value": "ta-left",
          "label": "Left"
        },
        {
          "value": "ta-center",
          "label": "Center"
        },
        {
          "value": "ta-right",
          "label": "Right"
        }
      ],
      "default": "ta-center"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "info": "Optional description text below heading"
    },
    {
      "type": "text",
      "id": "feed_url",
      "label": "Feed API URL",
      "default": "https://mitushi-ig-proxy.vercel.app/api/feed",
      "info": "Enter your Vercel API endpoint URL. Must start with https:// (e.g., https://mitushi-ig-proxy.vercel.app/api/feed)"
    },
    {
      "type": "select",
      "id": "layout_mode",
      "label": "Layout Mode",
      "options": [
        {
          "value": "grid",
          "label": "Grid"
        },
        {
          "value": "slider",
          "label": "Slider"
        }
      ],
      "default": "grid"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "label": "Columns (Desktop)",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4
    },
    {
      "type": "range",
      "id": "columns_mobile",
      "label": "Columns (Mobile)",
      "min": 1,
      "max": 3,
      "step": 1,
      "default": 2
    },
    {
      "type": "range",
      "id": "gap_size",
      "label": "Gap Size",
      "min": 4,
      "max": 32,
      "step": 2,
      "unit": "px",
      "default": 16
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Border Radius",
      "min": 0,
      "max": 24,
      "step": 2,
      "unit": "px",
      "default": 12
    },
    {
      "type": "select",
      "id": "media_ratio",
      "label": "Media ratio",
      "default": "1/1",
      "options": [
        {
          "value": "1/1",
          "label": "Square"
        },
        {
          "value": "2/3",
          "label": "Portrait 2:3"
        },
        {
          "value": "3/2",
          "label": "Landscape 3:2"
        },
        {
          "value": "auto",
          "label": "Adapt to image"
        }
      ]
    },
    {
      "type": "range",
      "id": "post_limit",
      "label": "Number of Posts",
      "min": 6,
      "max": 24,
      "step": 1,
      "default": 12
    },
    {
      "type": "checkbox",
      "id": "show_follow_button",
      "label": "Show Follow Button",
      "default": true
    },
    {
      "type": "text",
      "id": "follow_button_text",
      "label": "Follow Button Text",
      "default": "Follow @mitushi"
    },
    {
      "type": "range",
      "id": "button_font_size",
      "label": "Button Font Size",
      "min": 50,
      "max": 200,
      "step": 5,
      "unit": "%",
      "default": 100,
      "info": "Adjust button text size (50% - 200%)"
    },
    {
      "type": "text",
      "id": "instagram_handle",
      "label": "Instagram Handle",
      "info": "Without @ symbol (e.g., mitushi)",
      "default": "mitushi"
    },
    {
      "type": "text",
      "id": "error_message",
      "label": "Error Message",
      "default": "Unable to load Instagram feed. Please try again later.",
      "info": "Message shown if feed fails to load"
    },
    {
      "type": "select",
      "id": "color_scheme",
      "label": "Color Scheme",
      "options": [
        {
          "value": "default",
          "label": "Default"
        },
        {
          "value": "inverse",
          "label": "Inverse"
        },
        {
          "value": "accent-1",
          "label": "Accent 1"
        },
        {
          "value": "accent-2",
          "label": "Accent 2"
        }
      ],
      "default": "default"
    },
    {
      "type": "checkbox",
      "id": "remove_padding_top",
      "label": "Remove Top Padding",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "remove_padding_bottom",
      "label": "Remove Bottom Padding",
      "default": false
    }
  ],
  "presets": [
    {
      "name": "MITUSHI Instagram Feed"
    }
  ]
}
{% endschema %}
